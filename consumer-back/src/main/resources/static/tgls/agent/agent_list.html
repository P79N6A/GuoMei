<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1">
		<!-- Google Chrome Frame也可以让IE用上Chrome的引擎: -->
		<meta name="renderer" content="webkit">
		<!--国产浏览器高速模式-->
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="穷在闹市" />
		<!-- 作者 -->
		<meta name="revised" content="穷在闹市.v3, 2019/05/01" />
		<!-- 定义页面的最新版本 -->
		<meta name="description" content="网站简介" />
		<!-- 网站简介 -->
		<meta name="keywords" content="搜索关键字，以半角英文逗号隔开" />
		<title>穷在闹市出品</title>

		<!-- 公共样式 开始 -->
		<link rel="stylesheet" type="text/css" href="../../css/base.css">
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css">
		<script type="text/javascript" src="../../framework/jquery-1.11.3.min.js"></script>
		<link rel="stylesheet" type="text/css" href="../../layui/css/layui.css">
		<script type="text/javascript" src="../../layui/layui.js"></script>
		<!-- 滚动条插件 -->
		<link rel="stylesheet" type="text/css" href="../../css/jquery.mCustomScrollbar.css">
		<script src="../../framework/jquery-ui-1.10.4.min.js"></script>
		<script src="../../framework/jquery.mousewheel.min.js"></script>
		<script src="../../framework/jquery.mCustomScrollbar.min.js"></script>
		<script src="../../framework/cframe.js"></script><!-- 仅供所有子页面使用 -->
		<!-- 公共样式 结束 -->

		<style type="text/css">

			.layui-table-cell{
                 height: auto !important;
				 white-space: normal;
			}

			.layui-table img{
				max-height:25px
			}

			</style>

	</head>

	<body>
		<div class="cBody">
			<div class="console">
				<form class="layui-form" action="">
					<div class="layui-form-item">
						<div class="layui-input-inline">
							<input type="text"  lay-verify="required"  name="userName" required  placeholder="输入用户名" autocomplete="off" class="layui-input" >
						</div>
						<button class="layui-btn" lay-submit lay-filter="formDemo">查询</button>
					</div>
				</form>
			</div>

			<script type="text/html" id="barDemo">
				<a class="layui-btn layui-btn-xs" lay-event="edit">修改</a>
				<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
			</script>

			<table class="layui-hide" id="table" lay-filter="test"></table>


			<!--
    这里是弹出层的表单信息
    表单的id用于表单的选择，style是在本页隐藏，只有点击编辑才会弹出-->
			<div class="layui-row" id="popUpdateTest" style="display: none;">
					<form class="layui-form layui-from-pane" action="" style="margin-top:20px" lay-filter="example" id="userForm" enctype="mutipart/form-data" method="post">
						<input type="hidden" name="id">
						<div class="layui-form-item">
							<div class="layui-inline">
								<label class="layui-form-label">用户名</label>
								<div class="layui-input-inline">
									<input type="text" name="userName" lay-verify="required" id="userName"  autocomplete="off" class="layui-input">
								</div>
							</div>
							<div class="layui-inline">
								<label class="layui-form-label">性别</label>
								<div class="layui-input-inline">
									<input type="radio" name="sex" value="1" title="男">
									<input type="radio" name="sex" value="0" title="女">
								</div>
							</div>
						</div>

						<div class="layui-form-item">
						<!--	<div class="layui-inline">
								<label class="layui-form-label">生日</label>
								<div class="layui-input-inline">
									<input type="text" name="birthday"  lay-verify="required|date" placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input">
								</div>
							</div>
							-->
							<div class="layui-inline">
								<label class="layui-form-label">手机号码</label>
								<div class="layui-input-inline">
									<input type="tel" name="phone" lay-verify="required|phone" autocomplete="off" class="layui-input">
								</div>
							</div>
						</div>
						<div class="layui-form-item">
							<div class="layui-inline">
								<label class="layui-form-label">邮箱</label>
								<div class="layui-input-inline">
									<input type="text" name="email" lay-verify="required|email" autocomplete="off" class="layui-input">
								</div>
							</div>
						<!--	<div class="layui-inline">
								<label class="layui-form-label">注册时间</label>
								<div class="layui-input-inline">
									<input type="text" name="time"  lay-verify="required|date" placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input">
								</div>
							</div>-->
						</div>
						<div class="layui-form-item">
							<label class="layui-form-label">家庭住址</label>
							<div class="layui-input-block">
								<input type="text" name="address" lay-verify="required" autocomplete="off" class="layui-input">
							</div>
						</div>

						<div class="layui-upload">
							<button type="button" class="layui-btn" id="test1" name="headImg">头像图片</button>
							<div class="layui-upload-list">
								<img class="layui-upload-img" id="photo" name="headImg" width="50" height="50">
								<p id="demoText"></p>
							</div>
						</div>

						<div class="layui-form-item" style="margin-top:40px">
							<div class="layui-input-block">
								<button class="layui-btn  layui-btn-submit " lay-submit="" lay-filter="update" id="toUpdate">确认修改</button>
								<button type="reset" class="layui-btn layui-btn-primary">重置</button>
							</div>
						</div>
					</form>
			</div>







<script type="text/html" id="imgtmp">
	<div class="layer-photos-demo" onclick="img_click()" style="cursor:pointer;">
		<img layer-src="/fileupload/{{d.headImg}}" src="/fileupload/{{d.headImg}}" alt="头像图片"  >
	</div>
</script>



			
			<script>
				layui.use(['laypage', 'layer','table','upload','form'], function() {
					var laypage = layui.laypage,  //分页
						layer = layui.layer ,  //弹层
						table = layui.table , //表格
                        form = layui.form,
						$ = layui.jquery
                        ,upload = layui.upload;

                    //执行一个 table 实例
                    table.render({
                        elem: '#table'
                        ,height: 420
                        ,url: '/users/back/findUsers/'+null //数据接口
                        ,cellMinWidth: 60 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                        ,page: true //开启分页
                        ,done: function(res, curr, count) { //表格数据加载完后的事件
                            //调用示例
                            layer.photos({//点击图片弹出
                                photos: '.layer-photos-demo'
                                ,anim: 1 //0-6的选择，指定弹出图片动画类型，默认随机（请注意，3.0之前的版本用shift参数）
                            });
                            //如果是异步请求数据方式，res即为你接口返回的信息。
                            //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度
                            console.log(res);}
                        ,cols: [[ //表头
							{field: 'id', title: 'ID',fixed: 'left', sort: true,width:60}
                            ,{field: 'userName', title: '用户名',width:80}
                            ,{field: 'sex', title: '性别', sort: true,width:80,
                                    templet: function(d){
                                        if(d.sex == '1'){
                                            return '男'
                                        } else { return '女'}
                                    }
							}
                            ,{field: 'birthday', title: '生日',width:125}
                            ,{field: 'phone', title: '手机号码',width:150}
                            ,{field: 'email', title: '邮箱',width:180}
                            ,{field: 'address', title: '家庭住址',width:150}
                            ,{field: 'headImg', title: '头像图片',width:150,
                                templet:"#imgtmp"
                                }
                            ,{field: 'time', title: '注册时间',width:125}
                            ,{fixed: 'right', title:'操作', toolbar: '#barDemo',width:120}
                        ]]
                    });

                    //根据用户名模糊查询
                    form.on('submit(formDemo)', function(data) {
                        var userName=$("input[name=userName]").val();
                        table.reload("table",{
                            page:{
                                curr:1
							},url:'/users/back/findUsers/'+userName
						})
                        return false;
                    });

                    //监听行工具事件
                    table.on('tool(test)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
                        var data = obj.data //获得当前行数据
                            ,layEvent = obj.event; //获得 lay-event 对应的值
						//删除
                        if(layEvent === 'del'){
                            layer.confirm('真的删除行么?', function(index){
                             $.getJSON("/users/back/delUser/"+data.id,
                                    function(result) {
                                        if(result>0){
                                            obj.del(); //删除对应行（tr）的DOM结构，并更新缓
                                            layer.close(index);
                                            layer.msg("删除成功!");
                                        }
                                        else{
                                            layer.msg("删除失败,请重试!");
                                        }
                                    });
                                layer.close(index);
                            });
                        //修改
                        } else if(layEvent === 'edit'){
                            $.getJSON("/users/back/findById/"+data.id,
                                function(result) {
                                    $("#popUpdateTest input[name=id]").val(result.id);
                                  $("#popUpdateTest input[name=userName]").val(result.userName);
                                    $("input[name=sex][value="+result.sex+"]").prop("checked","true");
                                    $("#popUpdateTest input[name=birthday]").val(result.birthday);
                                    $("#popUpdateTest input[name=phone]").val(result.phone);
                                    $("#popUpdateTest input[name=email]").val(result.email);
                                    $("#popUpdateTest input[name=time]").val(result.time);
                                    $("#popUpdateTest input[name=address]").val(result.address);
                                    form.render();  //更新全部
                                });
                                   layer.open({
                                        //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                                        type: 1,
                                        title: "修改用户信息",
                                        area: [ '750px', '480px' ],
                                        content: $("#popUpdateTest")//引用的弹出层的页面层的方式加载修改界面表单
                                });
                                }
                            });


                    //普通图片上传
                    var uploadInst = upload.render({
                        elem: '#test1'
                        ,url: '/users/back/updateUser'
						,accept:"images"
                        ,auto: false   //true为选中图片直接提交
						,bindAction: '#toUpdate'
                        //选择文件后的回调
                        , choose: function (obj) {
                            obj.preview(function (index, file, result) {
                                $('#photo').attr('src', result);
                            })
                        },
                        //操作成功的回调
                       /* done: function (res, index, upload) {
                            var code = res.code === 0 ? 1 : 2;
                            layer.alert(res.msg, {icon: code}, function () {
                                parent.window.location.reload();
                            })
                        },*/
                        //上传错误回调
                        error: function (index, upload) {
                            layer.alert('上传失败！' + index);
                            var demoText = $('#demoText');
                            demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                            demoText.find('.demo-reload').on('click', function(){
                                uploadInst.upload();
                            });
                        }
                    });



                /*    function convertDateFromString(dateString) {
                        if (dateString) {
                            var date = new Date(dateString.replace(/-/,"/"))
                            return date;
                        }
                    }

                    var　 str　 =　 "2010-03-22";
                    var val = Date.parse(str);
                    var newDate = new Date(val);
                    alert(newDate);
*/

					//提交表单的方法
                    form.on('submit(update)', function (data) {
                        var fd = new FormData();
                        var formData = new FormData($( "#userForm" )[0]);
                        $.ajax({
                            cache : true,
                            type : "POST",
                            url : "/users/back/updateUser",
                            async : false,
                            data : formData,  // 你的formid
                            contentType: false,   //jax 中 contentType 设置为 false 是为了避免 JQuery 对其操作，从而失去分界符，而使服务器不能正常解析文件
                            processData: false,   //当设置为true的时候,jquery ajax 提交的时候不会序列化 data，而是直接使用data
                            success : function(result) {
                                if(result>0){

                                    layer.close(layer.index);
                                    window.parent.location.reload();

                                 /*  parent.layer.msg("修改成功");
                                    parent.reLoad();
                                    //注意这两句
                                    var index = parent.layer.getFrameIndex(window.name);///先得到当前iframe层的索引
                                    parent.layer.close(index);*/
                                 // location.href = "";
                                }else{
                                    parent.layer.alert("修改失败,请重试!")
                                }

                            }
                        })
                    });








				});







			</script>





















		</div>
	</body>

</html>